<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Compiled and minified JQuery -->
    <script src="JS/jquery.min.js"></script>
    <!-- Compiled and minified CSS -->
    <link rel="stylesheet" href="CSS/materialize.min.css">
    <!-- Compiled and minified JavaScript -->
    <script src="JS/materialize.min.js"></script>
    <script src="JS/chart.min.js"></script>
    <!-- Compiled Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Font Awesome CDN -->
    <link href="CSS/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="CSS/style.css" />
    <title>CovidLive</title>
    <style type="text/css">
    #form1 .label-icon i {
        margin-top: 50%;
        transform: translateY(-25%);
    }

    #form1 .input-field {
        height: 55px;
        top: 50%;
        transform: translateY(-50%);
    }

    .secondary-content {
        color: #000 !important;
        padding: 0 5px;
    }

    /* .card {
        margin: 0 !important;
    } */
    </style>
</head>

<body style="display: flex;flex-direction: column;height: 100vh;">
    <div id="navigation">
        <nav>
            <div class="nav-wrapper header">
                <a href="/home" class="brand-logo">
                    <span>CovidLive</span>
                </a>
                <a href="#" data-target="mobile-demo" class="sidenav-trigger"><i class="material-icons">menu</i></a>
            </div>
            <ul class="sidenav header" id="mobile-demo">
                <li class="accent" style="padding-top: 10px;">
                    <div class="container" style="font-size:18px">
                        <i style="font-size: 48px;margin:0" class="large material-icons row">account_box</i>
                        <div style="width: 100%" class="waves-effect row">
                            <span class="col s10">Hello, user</span><span style="padding-top: 10px;" class="col s1 material-icons">arrow_forward</span>
                        </div>
                    </div>
                </li>
                <li><a href="/home" class="waves-effect waves-accent icon-white">Home<i class="material-icons icon-white">home</i></a></li>
                <li><a href="/categories" class="waves-effect waves-accent icon-white">Categories<i class="material-icons icon-white">format_list_bulleted</i></a></li>
                <li><a href="/cart" class="waves-effect waves-accent icon-white">Cart<i class="material-icons icon-white">shopping_cart</i>
                        <span class="cart-value-text cart-value hide right" style="top:50%;transform:translateY(-50%);right: 10%;border-radius: 5px">5</span>
                    </a>
                </li>
                <hr>
                <li><a href="/contact" class="waves-effect waves-accent icon-white">Contact Us<i class="material-icons icon-white">email</i></a></li>
                <li><a onclick="clearText()" class="waves-effect waves-accent icon-white">Clear LocalStorage<i class="material-icons icon-white">question_answer</i></a></li>
            </ul>
    </div>
    <main style="flex-grow: 1;overflow: auto;position: relative;">
        <div id="content" style="flex-grow: 1;">
            <div class="container-fluid">
                <div id="meta">
                    <div class="card horizontal" style="width: 100%;margin-top:0 !important;">
                        <img class="c-img" height="50px" src="https://source.unsplash.com/random/100x100">
                        <h5 class="c-name" style="padding:0 5px">India</h5>
                    </div>
                    <div class="container">
                        <div class="card p2">
                            <strong>TOTAL CASES<a class="total-cases secondary-content"></a></strong>
                            <div class="percent" style="box-sizing: border-box">
                                <div style="" class="active line">
                                    <div style="width: 100%;height: 100%;background:grey"></div>
                                </div>
                                <div style="" class="recovered line">
                                    <div style="width: 100%;height: 100%;background:green"></div>
                                </div>
                                <div style="" class="deaths line">
                                    <div style="width: 100%;height: 100%;background:red"></div>
                                </div>
                            </div>
                            <ul class="stats" style="margin:20px 0">
                                <li class="count grey p2 lighten-2 font-weight-bold">
                                    <h5 class="center">
                                        <span class="active"></span>
                                        <span style="color:#fff !important;padding:0 5px;border-radius: 5px;" class="grey">+<small class="todayNew"></small></span>
                                    </h5>
                                    <p class="center">Active</p>
                                </li>
                                <li class="count green green-text text-darken-3 p2 lighten-5">
                                    Recovered
                                    <a href="" class="secondary-content recovered">0</a>
                                </li>
                                <li class="count red p2 red-text lighten-4">Casualities
                                    <a href="" class="secondary-content grey" style="color:#fff !important;padding:0 5px;border-radius: 5px;">
                                        &nbsp;+<small class="todayDeaths"></small>
                                    </a>
                                    <a class="secondary-content deaths" style="color:red !important">0</a>
                                </li>
                                <li class="count yellow p2 yellow-text text-darken-3 lighten-5">Serious cases
                                    <a class="secondary-content critical"></a>
                                </li>
                            </ul>
                            <strong class="grey-text">Last updated <span class="last-updated"></span></strong>
                        </div>
                        <div class="card p2">
                            <p class="font-weight-bold center">Total People Tested</p>
                            <h5 class="font-weight-bold center tested grey-text">4585</h5>
                        </div>
                    </div>
                </div>
                <div id="dataOfCountry">
                    <div class="container white" style="height: 300px;margin-top: 50px">
                        <canvas style="height: 100%;max-height: 300px" id="caseChart"></canvas>
                    </div>
                    <div class="container green lighten-5" style="height: 300px;margin-top: 50px">
                        <canvas style="height: 100%;max-height: 300px" id="recoveredChart"></canvas>
                    </div>
                    <div class="container red lighten-5" style="height: 300px;margin-top: 50px">
                        <canvas style="height: 100%;max-height: 300px" id="deathChart"></canvas>
                    </div>
                </div>
                <div class="container" style="margin-top: 10px">
                    <h6 class="font-weight-bold p2">SEARCH BY DATE</h6>
                    <div class="row">
                        <input type="text" class="datepicker col s8" placeholder="Select the Date">
                        <button class="btn col s4 indigo" id="searchDate">search</button>
                    </div>
                    <div class="col s12 sbd">
                        <div class="card p2">
                            <p class="card-title">Results till <span id="selectedDate"></span></p>
                            <p>Cases<span class="secondary-content" id="selectedActive">45</span></p>
                            <p>Recovered<span class="secondary-content" id="selectedRecovered">45</span></p>
                            <p>Deaths<span class="secondary-content" id="selectedDeaths">45</span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div style="position: absolute;top: 50%;left: 50%;transform:translate(-50%,-50%);">
            <div class="preloader-wrapper big active">
                <div class="spinner-layer spinner-blue-only">
                    <div class="circle-clipper left">
                        <div class="circle"></div>
                    </div>
                    <div class="gap-patch">
                        <div class="circle"></div>
                    </div>
                    <div class="circle-clipper right">
                        <div class="circle"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <script>
    let ddd;
    let country, newDate;
    $(document).ready(function() {
        $('.sidenav').sidenav();
        $(".sbd").hide()
        $('.fixed-action-btn').floatingActionButton();
        $('.datepicker').datepicker({
            onSelect: e => {
                newDate = e.getFullYear() + "-" + (e.getMonth() + 1 + "").padStart(2, 0) + "-" + (e.getDate() + "").padStart(2, 0)
            },
            maxDate: new Date(new Date().setDate(new Date().getDate() - 1)),
            minDate: new Date("1 dec 2019")
        });
        $("#searchDate").click(e => {
            $(".sbd").show()
            showDataForDate(newDate)
            $('main').animate({ scrollTop: $(".container-fluid").height() }, 1200);
        })
        showCountryData();
    });

    function showCountryData() {
        country = location.search.slice(1);
        country = country.split("&");
        printData(JSON.parse(localStorage.covidMeta).find(e => e.country.toLowerCase() == (country[1]).toLowerCase()));
        let status = true
        if (localStorage["Chart" + country[1]]) {
            showData(JSON.parse(localStorage["Chart" + country[1]]))
            return;
        }
        fetch(`https://covidapi.info/api/v1/country/${country[0]}`)
            .then(d => {
                if (d.status != 200)
                    throw new Error("Not found");
                else
                    return d.json()
            })
            .then(e => {
                localStorage["Chart" + country[1]] = JSON.stringify(e.result);
                if (e)
                    showData(e.result);
            })
            .catch(r => {
                console.log(r);
            })
    }

    function showDataForDate(date) {

        let data = JSON.parse(localStorage["Chart" + country[1]])[date];
        $("#selectedActive").text(data.confirmed)
        $("#selectedRecovered").text(data.recovered)
        $("#selectedDeaths").text(data.deaths)
        let newD = new Date(date);
        let d = $(".sbd").html()
        $(".sbd").html("please wait...")
        setTimeout(e => {
            $(".sbd").html(d)
            $("#selectedDate").html("<small class='secondary-content'>" + newDate.split("-").reverse().join("-") + "</small>")
        }, 500)
    }

    function findFurther(c) {
        if (!localStorage[c]) {
            let data;
            fetch(`https://corona.lmao.ninja/countries/${c}`)
                .then(d => d.json())
                .then(e => {
                    localStorage[c] = JSON.stringify(e);
                    printData(e);
                })
        } else {
            printData(JSON.parse(localStorage[c]));
            if (5 > 2) {
                alert("new Data")
                let data;
                fetch(`https://corona.lmao.ninja/countries/${c}`)
                    .then(d => d.json())
                    .then(e => {
                        localStorage[c] = JSON.stringify(e);
                        printData(e);
                    })
            }
        }
    }

    function printData(data) {
        $(".preloader-wrapper").hide();
        $(".c-img")[0].src = data.countryInfo.flag;
        $(".c-name").text(data.country);
        let subtotal = data.active + data.deaths + data.recovered
        $(".percent .active").width((data.active * 100 / subtotal).toFixed(2) + "%");
        $(".percent .deaths").width((data.deaths * 100 / subtotal).toFixed(2) + "%");
        $(".percent .recovered").width((data.recovered * 100 / subtotal).toFixed(2) + "%");

        $(".line").height(10);
        $(".line").css({ float: "left", padding: "1px", textAlign: "center" })
        $(".line div").css({ borderRadius: "5px" })

        $(".stats .active").text(data.active.toLocaleString());
        $(".stats .deaths").text(data.deaths.toLocaleString());
        $(".stats .recovered").text(data.recovered.toLocaleString())
        $(".total-cases").text(data.cases.toLocaleString())
        $(".todayNew").text(data.todayCases.toLocaleString() + " new")
        $(".todayDeaths").text(data.todayDeaths.toLocaleString() + " today")
        $(".critical").text(data.critical.toLocaleString())
        $(".tested").text(data.tests.toLocaleString())
        $(".last-updated").text(new Date(data.updated).toLocaleString())
    }

    async function showData(ddd) {
        let dates = [],
            deaths = [],
            totalCases = [],
            recovered = [];
        for (i in ddd) {
            deaths.push(ddd[i].deaths)
            totalCases.push(ddd[i].confirmed)
            recovered.push(ddd[i].recovered)
            dates.push(i)
        }
        buildChart(dates, deaths, "#deathChart", "deaths", "red");
        buildChart(dates, recovered, "#recoveredChart", "recovered", "green");
        buildChart(dates, totalCases, "#caseChart", "cases", "darkgrey");
    }

    function buildChart(x, y, target, type, color) {
        window.t = y;
        var ctx = document.querySelector(target).getContext("2d");
        var myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: x.map(e => e.split("-").slice(1).reverse().join("-")),
                datasets: [{
                    label: "Total " + type,
                    data: y,
                    borderColor: color,
                    fill: false
                }]
            },
            options: {
                maintainAspectRatio: false,
                title: {
                    display: true,
                    text: "Timeline for total " + type
                },
                elements: {
                    point: {
                        radius: 0,
                        hitRadius: 10,
                        hoverRadius: 5
                    }
                },
                scales: {
                    yAxes: [{
                        ticks: {
                            beginAtZero: true,
                            maxTicksLimit: 5
                        }
                    }],
                    xAxes: [{
                        ticks: {
                            autoSkip: true,
                            maxTicksLimit: 5
                        }
                    }]

                }
            }
        })
        myChart.update()
    }

    function clearText() {
        localStorage.clear();
        history.go(-2)
    }
    </script>
</body>

</html>